<!DOCTYPE>
<html>
<head>
	<title>WebSocket Chat Test</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
</head>

<body>
<h1>WebSocket Chat Test</h1>
<input type="text" id="chatRoomIdInput" placeholder="Chat Room ID (e.g., 1)">
<input type="text" id="senderIdInput" placeholder="Your Sender ID (e.g., 1)">
<input type="text" id="senderUsernameInput" placeholder="Your Username (e.g., Alice)">
<button onclick="connectAndJoin()">Connect & Join</button>
<button onclick="disconnect()">Disconnect</button>

<hr>

<div id="messages"></div>
<input type="text" id="messageInput" placeholder="Type your message...">
<button onclick="sendMessage()">Send</button>

<script>
	var stompClient = null;
	var chatRoomId = null;
	var senderId = null;
	var senderUsername = null;

	function connectAndJoin() {
		chatRoomId = document.getElementById('chatRoomIdInput').value;
		senderId = document.getElementById('senderIdInput').value;
		senderUsername = document.getElementById('senderUsernameInput').value;

		if (!chatRoomId || !senderId || !senderUsername) {
			alert("Please enter Chat Room ID, Sender ID, and Username.");
			return;
		}

		const socket = new SockJS('http://localhost:8081/ws');
		stompClient = Stomp.over(socket);

		stompClient.connect({}, function (frame) {
			console.log('Connected: ' + frame);

			// 특정 채팅방 구독
			stompClient.subscribe('/topic/chatroom/' + chatRoomId, function (message) {
				showMessage(JSON.parse(message.body));
			});

			// JOIN 메시지 전송
			var joinMessage = {
				chatRoomId: chatRoomId,
				senderId: senderId,
				senderUsername: senderUsername,
				message: senderUsername + ' joined chat room ' + chatRoomId,
				type: 'JOIN'
			};

			stompClient.send("/app/chat.addUser", {}, JSON.stringify(joinMessage));

		}, function(error) {

			console.error("STOMP Error: " + error);

			alert("Failed to connect to WebSocket. Is the server running?");

		});

	}



	function disconnect() {

		if (stompClient !== null) {

			stompClient.disconnect();

		}

		console.log("Disconnected");

	}



	function sendMessage() {

		var messageContent = document.getElementById('messageInput').value;

console.log(messageContent);
console.log(chatRoomId);
		if (messageContent && stompClient && chatRoomId && senderId && senderUsername) {

			var chatMessage = {

				chatRoomId: chatRoomId,

				senderId: senderId,

				senderUsername: senderUsername,

				message: messageContent,

				type: 'CHAT'

			};

			stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));

			document.getElementById('messageInput').value = '';

		} else {

			alert("Please connect to a chat room first and enter a message.");

		}

	}



   function showMessage(message) {

		var messagesDiv = document.getElementById('messages');

		var p = document.createElement('p');

		p.innerHTML = '<strong>' + message.senderUsername + ':</strong> ' + message.message;

		messagesDiv.appendChild(p);

		messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom

	}

</script>

</body>

</html>